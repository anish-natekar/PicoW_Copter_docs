<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Welcome to PicoW_Copter_Docs’s documentation! &mdash; PicoW_Copter_Docs 1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#" class="icon icon-home">
            PicoW_Copter_Docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Welcome to PicoW_Copter_Docs’s documentation!</a></li>
<li><a class="reference internal" href="#about-author">About Author</a></li>
<li><a class="reference internal" href="#hardware">Hardware</a><ul>
<li><a class="reference internal" href="#bill-of-materials">Bill of Materials</a></li>
<li><a class="reference internal" href="#pcb">PCB</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing">Testing</a><ul>
<li><a class="reference internal" href="#receiver">Receiver</a></li>
<li><a class="reference internal" href="#gyro">Gyro</a></li>
<li><a class="reference internal" href="#motors-escs">Motors + ESCs</a></li>
<li><a class="reference internal" href="#bmp280-not-yet-tested-or-used-in-flight-controller">BMP280 (Not yet tested or used in flight controller)</a></li>
<li><a class="reference internal" href="#battery-voltage">Battery voltage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#software">Software</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">PicoW_Copter_Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Welcome to PicoW_Copter_Docs’s documentation!</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="welcome-to-picow-copter-docs-s-documentation">
<h1>Welcome to PicoW_Copter_Docs’s documentation!<a class="headerlink" href="#welcome-to-picow-copter-docs-s-documentation" title="Permalink to this heading"></a></h1>
<p>This is the Official Documentation for the PicoW Copter
The PicoW Copter is an open source micro sub 60g quadcopter that is controlled using WiFi via a smartphone or computer.
The PicoW Copter is designed to be a low cost, easy to build, and fun to fly quadcopter.</p>
</section>
<section id="about-author">
<h1>About Author<a class="headerlink" href="#about-author" title="Permalink to this heading"></a></h1>
<p>The Raspberry pi pico W Quadcopter is a project made by Anish Natekar during the summer break after his 3rd semester of BTech
in Computer Science and Engineering at IIT Goa using the knowledge gained from working on Quadcopters, Robots and RC planes for a about year.
This project is a way to give back to the community and help others learn about quadcopters, pcb designing, electronics, sensors, wired+wireless communication and programming.
The cost for the complete project is between Rs 2000 to Rs 2500 (INR) i.e. near $25 to $30 (USD) and the list for the componets, pcb gerbers, android APP, quadcopter code is all open source.
This quadcopter is small enough to fly indoors and not cause too much damage on collision but please do take necessary precautions while flying.
This quadcopter is light enough to not require any registration/certification in countries like India and the USA but please do check your local laws before flying.</p>
</section>
<section id="hardware">
<h1>Hardware<a class="headerlink" href="#hardware" title="Permalink to this heading"></a></h1>
<p>The Hardware required can be found in the Hardware folder of PicoW Copter project.
The Harware folders contains a BOM, PCB gerber files, and STL file for the frame.
The BOM provided contains links for the parts from online indian websites but you can easily find them for other countries as well.</p>
<section id="bill-of-materials">
<h2>Bill of Materials<a class="headerlink" href="#bill-of-materials" title="Permalink to this heading"></a></h2>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">BOM</span><a class="headerlink" href="#id1" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Part Name</p></th>
<th class="head"><p>Quantity</p></th>
<th class="head"><p>Link</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Raspberry Pi Pico W</p></td>
<td><p>1</p></td>
<td><p><a class="reference external" href="https://robu.in/product/raspberry-pi-pico-w/">https://robu.in/product/raspberry-pi-pico-w/</a> |</p></td>
</tr>
<tr class="row-odd"><td><p>MPU6050</p></td>
<td><p>1</p></td>
<td><p><a class="reference external" href="https://robu.in/product/mpu-6050-gyro-sensor-2-accelerometer/">https://robu.in/product/mpu-6050-gyro-sensor-2-accelerometer/</a> |</p></td>
</tr>
<tr class="row-even"><td><p>1S 360mAh Lipo Battery</p></td>
<td><p>1</p></td>
<td><p><a class="reference external" href="https://robu.in/product/orange-360-mah-1s-30c-60c-lithium-polymer-battery-pack-lipo/">https://robu.in/product/orange-360-mah-1s-30c-60c-lithium-polymer-battery-pack-lipo/</a> |</p></td>
</tr>
<tr class="row-odd"><td><p>720 Coreless Motor</p></td>
<td><p>4</p></td>
<td><p><a class="reference external" href="https://robu.in/product/8520-magnetic-micro-coreless-motor-for-micro-quadcopters-2xcw-2xccw/">https://robu.in/product/8520-magnetic-micro-coreless-motor-for-micro-quadcopters-2xcw-2xccw/</a> |</p></td>
</tr>
<tr class="row-even"><td><p>55mm Propeller (included with motors)</p></td>
<td><p>4</p></td>
<td><p><a class="reference external" href="https://robu.in/product/8520-magnetic-micro-coreless-motor-for-micro-quadcopters-2xcw-2xccw/">https://robu.in/product/8520-magnetic-micro-coreless-motor-for-micro-quadcopters-2xcw-2xccw/</a> |</p></td>
</tr>
<tr class="row-odd"><td><p>si2302 N channel Mosfet</p></td>
<td><p>4</p></td>
<td><p><a class="reference external" href="https://www.ktron.in/product/si2302-mosfet-sot23/">https://www.ktron.in/product/si2302-mosfet-sot23/</a> |</p></td>
</tr>
<tr class="row-even"><td><p>1N4007 Diode</p></td>
<td><p>4</p></td>
<td><p><a class="reference external" href="https://robu.in/product/1n4148-surface-mount-zener-diode-pack-of-30/">https://robu.in/product/1n4148-surface-mount-zener-diode-pack-of-30/</a> |</p></td>
</tr>
<tr class="row-odd"><td><p>Male Pin headers</p></td>
<td><p>44</p></td>
<td><p><a class="reference external" href="https://www.ktron.in/product/header-pins-40x1-2-54mm-pitch-brass/">https://www.ktron.in/product/header-pins-40x1-2-54mm-pitch-brass/</a> |</p></td>
</tr>
<tr class="row-even"><td><p>Female Pin headers</p></td>
<td><p>40</p></td>
<td><p><a class="reference external" href="https://www.ktron.in/product/berg-strip-female-2-54mm-brass/">https://www.ktron.in/product/berg-strip-female-2-54mm-brass/</a> |</p></td>
</tr>
<tr class="row-odd"><td><p>XH male connector</p></td>
<td><p>1</p></td>
<td><p><a class="reference external" href="https://www.ktron.in/product/2pin-jst-xh-male-connector/">https://www.ktron.in/product/2pin-jst-xh-male-connector/</a> |</p></td>
</tr>
<tr class="row-even"><td><p>Push Button</p></td>
<td><p>1</p></td>
<td><p><a class="reference external" href="https://www.ktron.in/product/3x6x2-5mm-tactile-switch-smd/">https://www.ktron.in/product/3x6x2-5mm-tactile-switch-smd/</a> |</p></td>
</tr>
<tr class="row-odd"><td><p>BMP 280 (Not used yet but will be used in future)</p></td>
<td><p>1</p></td>
<td><p><a class="reference external" href="https://robu.in/product/bmp280-barometric-pressure-and-altitude-sensor-i2c-spi-module/">https://robu.in/product/bmp280-barometric-pressure-and-altitude-sensor-i2c-spi-module/</a> |</p></td>
</tr>
<tr class="row-even"><td><p>1S Lipo charger</p></td>
<td><p>1</p></td>
<td><p><a class="reference external" href="https://robu.in/product/4-port-dc5v-1s-rc-lithium-lipo-battery-compact-balance-charger-rc-quadcopter/">https://robu.in/product/4-port-dc5v-1s-rc-lithium-lipo-battery-compact-balance-charger-rc-quadcopter/</a> |</p></td>
</tr>
</tbody>
</table>
<p>Taking Rs 160 for 1 PCB and Rs 160 for 3D printed frame from an online service.
The total cost of the hardware is just above 2000 INR or 25 USD.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Most of the hardware won’t be available in small quantities so it is adviced to anyone looking to build this project to try to build multiple of them either for yourself or a group of friends.</p>
</div>
</section>
<section id="pcb">
<h2>PCB<a class="headerlink" href="#pcb" title="Permalink to this heading"></a></h2>
<a class="reference internal image-reference" href="_images/PCB.png"><img alt="PCB" class="align-center" src="_images/PCB.png" style="width: 80%;" /></a>
<p>The PCB Gerber files are given in the <em>PCB_Gerber_PicoW_Copter</em> folder.
The PCB is a double layered, 4cm X 6cm, 1oz copper, 1.6mm PCB.</p>
<a class="reference internal image-reference" href="_images/Schematic_PicoW_Copter.png"><img alt="Schematic" class="align-center" src="_images/Schematic_PicoW_Copter.png" style="width: 100%;" /></a>
</section>
</section>
<section id="testing">
<h1>Testing<a class="headerlink" href="#testing" title="Permalink to this heading"></a></h1>
<p>Testing script are not only useful to test individual hardware components of the PicoW Copter
but also a great way to learn how individual components work.
This project is complex but extremely affordable allowing room for errors and mistakes even for complete beginners.
Anyone looking to modify the code and hardware is more than welcome to do so.</p>
<section id="receiver">
<h2>Receiver<a class="headerlink" href="#receiver" title="Permalink to this heading"></a></h2>
<p>The PicoW Copter uses the onboard infenion WiFi chip of the raspberry Pi PicoW to communicate with a device (smartphone or computer) through UDP packets.
The static IP address when using the Pi Pico over access point mode (hotspot mode) is 192.168.1.42 by default.
The main motivation for using UDP is real time control of the PicoW Copter. The time taken to read packets is around 200 microseconds.</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFi.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFiUdp.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#ifndef APSSID</span>
<span class="linenos"> 5</span><span class="cp">#define APSSID &quot;PicoW&quot;    </span><span class="c1">// name of your PicoW Hotspot</span>
<span class="linenos"> 6</span><span class="cp">#define APPSW &quot;password&quot; </span><span class="c1">// password of your PicoW Hotspot</span>
<span class="linenos"> 7</span><span class="cp">#endif</span>
<span class="linenos"> 8</span><span class="cp">#define UDP_PKT_MAX_SIZE 16 </span><span class="c1">//  number of characters in a UDP packet</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">localPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8888</span><span class="p">;</span><span class="w">  </span><span class="c1">// local port for UDP communication</span>
<span class="linenos">11</span><span class="kr">char</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">UDP_PKT_MAX_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">  </span><span class="c1">// max number of characters received in one message</span>
<span class="linenos">12</span><span class="kr">int</span><span class="w"> </span><span class="n">Throttle</span><span class="p">,</span><span class="w"> </span><span class="n">Roll</span><span class="p">,</span><span class="w"> </span><span class="n">Pitch</span><span class="p">,</span><span class="w"> </span><span class="n">Yaw</span><span class="p">;</span><span class="w"> </span><span class="c1">// values received from each channel</span>
<span class="linenos">13</span><span class="kr">int</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="nf">WiFiUDP</span><span class="w"> </span><span class="n">Udp</span><span class="p">;</span><span class="w"> </span><span class="c1">// Object for WIFI UDP class</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">18</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="linenos">19</span><span class="w">  </span><span class="nf">WiFi</span><span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="n">WIFI_AP</span><span class="p">);</span><span class="w"> </span><span class="c1">// Access Point mode</span>
<span class="linenos">20</span><span class="w">  </span><span class="nf">WiFi</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="n">APSSID</span><span class="p">,</span><span class="w"> </span><span class="n">APPSW</span><span class="p">);</span><span class="w">  </span><span class="c1">// By default static IP for PicoW will be 192.168.42.1</span>
<span class="linenos">21</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nf">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">WL_CONNECTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">22</span><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// waiting for connection</span>
<span class="linenos">23</span><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0.5 sec delay</span>
<span class="linenos">24</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">25</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Connected! IP address: &quot;</span><span class="p">);</span>
<span class="linenos">26</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="nf">WiFi</span><span class="p">.</span><span class="nf">localIP</span><span class="p">());</span><span class="w">   </span><span class="c1">// The IP Address is 192.168.42.1</span>
<span class="linenos">27</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;UDP server on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">localPort</span><span class="p">);</span><span class="w">  </span><span class="c1">// Port is 8888</span>
<span class="linenos">28</span><span class="w">  </span><span class="n">Udp</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="n">localPort</span><span class="p">);</span><span class="w"> </span><span class="c1">// start listening on port 8888</span>
<span class="linenos">29</span><span class="p">}</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">32</span><span class="w">  </span><span class="c1">// if there is data available to read then read a packet</span>
<span class="linenos">33</span><span class="w">  </span><span class="kr">int</span><span class="w"> </span><span class="n">packetSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Udp</span><span class="p">.</span><span class="nf">parsePacket</span><span class="p">();</span>
<span class="linenos">34</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">packetSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// if packet size is &gt; 0</span>
<span class="linenos">35</span><span class="w">    </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">micros</span><span class="p">();</span>
<span class="linenos">36</span><span class="w">    </span><span class="kr">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Udp</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UDP_PKT_MAX_SIZE</span><span class="p">);</span><span class="w"> </span><span class="c1">// read the data from UDP packet into packetBuffer</span>
<span class="linenos">37</span><span class="w">    </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// character for end of string</span>
<span class="linenos">38</span><span class="w">    </span><span class="kr">char</span><span class="w"> </span><span class="n">ch1</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch2</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch3</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch4</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w">  </span><span class="c1">//</span>
<span class="linenos">39</span><span class="w">    </span><span class="n">ch1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch3</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch4</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">40</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">41</span><span class="w">      </span><span class="c1">// Spliting the packets into four values of 4 characters each</span>
<span class="linenos">42</span><span class="w">      </span><span class="n">ch1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">43</span><span class="w">      </span><span class="n">ch2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos">44</span><span class="w">      </span><span class="n">ch3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">];</span>
<span class="linenos">45</span><span class="w">      </span><span class="n">ch4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">];</span>
<span class="linenos">46</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">47</span><span class="w">    </span><span class="c1">// converting string/character arrays to integer</span>
<span class="linenos">48</span><span class="w">    </span><span class="n">Yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch1</span><span class="p">);</span>
<span class="linenos">49</span><span class="w">    </span><span class="n">Throttle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch2</span><span class="p">);</span>
<span class="linenos">50</span><span class="w">    </span><span class="n">Roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch3</span><span class="p">);</span>
<span class="linenos">51</span><span class="w">    </span><span class="n">Pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch4</span><span class="p">);</span>
<span class="linenos">52</span><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Yaw = %d, Throttle = %d, Roll = %d, Pitch = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Yaw</span><span class="p">,</span><span class="w"> </span><span class="n">Throttle</span><span class="p">,</span><span class="w"> </span><span class="n">Roll</span><span class="p">,</span><span class="w"> </span><span class="n">Pitch</span><span class="p">);</span>
<span class="linenos">53</span><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Time taken = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">micros</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev</span><span class="p">);</span>
<span class="linenos">54</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">55</span><span class="p">}</span>
</pre></div>
</div>
<p>The UDP packets are sent by an APP or software (in our case this python code) on the device to the PicoW’s IP address and port number provided in the Receiver.ino file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">UDP_IP</span> <span class="o">=</span> <span class="s2">&quot;192.168.1.42&quot;</span>
<span class="linenos"> 5</span><span class="n">UDP_PORT</span> <span class="o">=</span> <span class="mi">8888</span>
<span class="linenos"> 6</span><span class="n">MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;1000100110021003&quot;</span> <span class="c1"># sending four 4 digit long numbers</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="c1"># creating a UDP socket (UDP is connection less)</span>
<span class="linenos"> 9</span><span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
<span class="linenos">10</span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">11</span>    <span class="n">server</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">MESSAGE</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">UDP_IP</span><span class="p">,</span> <span class="n">UDP_PORT</span><span class="p">))</span>
<span class="linenos">12</span>    <span class="c1"># sleep for 1 second</span>
<span class="linenos">13</span>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="gyro">
<h2>Gyro<a class="headerlink" href="#gyro" title="Permalink to this heading"></a></h2>
<p>The MPU6050 is a 6 axis gyroscope and accelerometer sensor. It is used to measure the orientation of the PicoW Copter.
The MPU6050 is connected to the Pi PicoW using I2C protocol communicatin at a frequency of 400kHz. The I2C address of the MPU6050 is 0x68.
All i2c register addresses can be found in the MPU6050 manual by invensense. Joop Brokking has a great tutorial on how to use the MPU6050 with Arduino.
The time taken to read IMU data is around 400 microseconds.</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="cpf">&lt;Wire.h&gt;</span>
<span class="linenos">  2</span>
<span class="linenos">  3</span><span class="cp">#define I2C_CLK_FREQ 400000 </span><span class="c1">// 400kHz</span>
<span class="linenos">  4</span><span class="kr">const</span><span class="w"> </span><span class="n">u_int8_t</span><span class="w"> </span><span class="n">IMUAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x68</span><span class="p">;</span><span class="w">  </span><span class="c1">// Address for MPU6050 IMU sensor</span>
<span class="linenos">  5</span><span class="c1">// IMU offset</span>
<span class="linenos">  6</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">gyroXoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">  7</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">gyroYoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">  8</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">gyroZoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">  9</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">accXoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 10</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">accYoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 11</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">accZoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 12</span><span class="c1">// MPU6050 IMU</span>
<span class="linenos"> 13</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">accX</span><span class="p">,</span><span class="w"> </span><span class="n">accY</span><span class="p">,</span><span class="w"> </span><span class="n">accZ</span><span class="p">;</span><span class="w"> </span><span class="c1">// accelerometer</span>
<span class="linenos"> 14</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">tempRaw</span><span class="p">;</span>
<span class="linenos"> 15</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">gyroX</span><span class="p">,</span><span class="w"> </span><span class="n">gyroY</span><span class="p">,</span><span class="w"> </span><span class="n">gyroZ</span><span class="p">;</span><span class="w"> </span><span class="c1">// gyroscope</span>
<span class="linenos"> 16</span><span class="kr">float</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span><span class="w"> </span><span class="c1">// temperature</span>
<span class="linenos"> 17</span><span class="kr">int</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">   </span><span class="c1">// keeps track of time before reading IMU data</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 20</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span><span class="w"> </span><span class="c1">// set the built in LED pin as Output</span>
<span class="linenos"> 21</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="linenos"> 22</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="n">setClock</span><span class="p">(</span><span class="n">I2C_CLK_FREQ</span><span class="p">);</span><span class="w">  </span><span class="c1">// setting I2C communication frequency to 400kHz</span>
<span class="linenos"> 23</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">begin</span><span class="p">();</span><span class="w"> </span><span class="c1">// starting I2C communication over SDA0 and SCL0 pins</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">IMUAddress</span><span class="p">);</span>
<span class="linenos"> 26</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x6B</span><span class="p">);</span><span class="w"> </span><span class="c1">// PWR_MGMT_1</span>
<span class="linenos"> 27</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
<span class="linenos"> 28</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">IMUAddress</span><span class="p">);</span>
<span class="linenos"> 31</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x1B</span><span class="p">);</span><span class="w"> </span><span class="c1">// GYRO_CONFIG</span>
<span class="linenos"> 32</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x08</span><span class="p">);</span><span class="w"> </span><span class="c1">// +- 1000 degrees/s</span>
<span class="linenos"> 33</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">IMUAddress</span><span class="p">);</span>
<span class="linenos"> 36</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x1C</span><span class="p">);</span><span class="w"> </span><span class="c1">// ACCEL_CONFIG</span>
<span class="linenos"> 37</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span><span class="w"> </span><span class="c1">// +- 16g</span>
<span class="linenos"> 38</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">IMUAddress</span><span class="p">);</span>
<span class="linenos"> 41</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x1A</span><span class="p">);</span><span class="w"> </span><span class="c1">// CONFIG</span>
<span class="linenos"> 42</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x03</span><span class="p">);</span>
<span class="linenos"> 43</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="w">  </span><span class="c1">// IMU offset calculation</span>
<span class="linenos"> 46</span><span class="w">  </span><span class="kr">int</span><span class="w"> </span><span class="n">offcnt</span><span class="p">;</span>
<span class="linenos"> 47</span><span class="w">  </span><span class="kr">long</span><span class="w"> </span><span class="n">gx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">gz</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">az</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// variables to store sum of 1000 readings</span>
<span class="linenos"> 48</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">offcnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">offcnt</span><span class="o">&lt;=</span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">offcnt</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 49</span><span class="w">    </span><span class="c1">// Reading IMU data 1000 times to calculate offset values of IMU</span>
<span class="linenos"> 50</span><span class="w">    </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">IMUAddress</span><span class="p">);</span>
<span class="linenos"> 51</span><span class="w">    </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x3B</span><span class="p">);</span><span class="w"> </span><span class="c1">// GyroXhigh byte</span>
<span class="linenos"> 52</span><span class="w">    </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 53</span><span class="w">    </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">requestFrom</span><span class="p">(</span><span class="n">IMUAddress</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">);</span><span class="w"> </span><span class="c1">// request 14 bytes of data from IMU</span>
<span class="linenos"> 54</span><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">available</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">14</span><span class="p">);</span><span class="w"> </span><span class="c1">// If we have received 14 bytes exit out of loop</span>
<span class="linenos"> 55</span><span class="w">    </span><span class="c1">// read IMU data values</span>
<span class="linenos"> 56</span><span class="w">    </span><span class="n">accX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 57</span><span class="w">    </span><span class="n">accY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="n">accZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 59</span><span class="w">    </span><span class="n">tempRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="n">gyroX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="n">gyroY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 62</span><span class="w">    </span><span class="n">gyroZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="c1">// Sum the values read from IMU</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="n">gx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gyroX</span><span class="p">;</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="n">gy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gyroY</span><span class="p">;</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="n">gz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gyroZ</span><span class="p">;</span>
<span class="linenos"> 67</span><span class="w">    </span><span class="n">ax</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">accX</span><span class="p">;</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="n">ay</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">accY</span><span class="p">;</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="n">az</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">accZ</span><span class="p">;</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="c1">// simulating delay for rest of the quadcopter processes</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">offcnt</span><span class="o">%</span><span class="mi">40</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 72</span><span class="w">      </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="kr">HIGH</span><span class="p">);</span><span class="w">  </span><span class="c1">// LED blinks to indicate offset calculation is going on</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 74</span><span class="w">      </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="kr">LOW</span><span class="p">);</span>
<span class="linenos"> 75</span><span class="w">  </span><span class="p">}</span>
<span class="linenos"> 76</span><span class="w">  </span><span class="c1">// get the average of 1000 readings</span>
<span class="linenos"> 77</span><span class="w">  </span><span class="n">gyroXoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">int16_t</span><span class="p">)(</span><span class="n">gx</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos"> 78</span><span class="w">  </span><span class="n">gyroYoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">int16_t</span><span class="p">)(</span><span class="n">gy</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos"> 79</span><span class="w">  </span><span class="n">gyroZoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">int16_t</span><span class="p">)(</span><span class="n">gz</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos"> 80</span><span class="w">  </span><span class="n">accXoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">int16_t</span><span class="p">)(</span><span class="n">ax</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos"> 81</span><span class="w">  </span><span class="n">accYoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">int16_t</span><span class="p">)(</span><span class="n">ay</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos"> 82</span><span class="w">  </span><span class="n">accZoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">int16_t</span><span class="p">)(</span><span class="n">az</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos"> 83</span><span class="p">}</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 86</span><span class="w">  </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">micros</span><span class="p">();</span><span class="w">  </span><span class="c1">// record time when we started reading IMU data</span>
<span class="linenos"> 87</span><span class="w">  </span><span class="c1">// read IMU values</span>
<span class="linenos"> 88</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">IMUAddress</span><span class="p">);</span>
<span class="linenos"> 89</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x3B</span><span class="p">);</span>
<span class="linenos"> 90</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 91</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">requestFrom</span><span class="p">(</span><span class="n">IMUAddress</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">);</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">available</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">14</span><span class="p">);</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span><span class="w">  </span><span class="n">accX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 96</span><span class="w">  </span><span class="n">accY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 97</span><span class="w">  </span><span class="n">accZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 98</span><span class="w">  </span><span class="n">tempRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 99</span><span class="w">  </span><span class="n">gyroX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos">100</span><span class="w">  </span><span class="n">gyroY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos">101</span><span class="w">  </span><span class="n">gyroZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos">102</span><span class="w">  </span><span class="c1">// subtract offset from readings</span>
<span class="linenos">103</span><span class="w">  </span><span class="n">gyroX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">gyroXoffset</span><span class="p">;</span>
<span class="linenos">104</span><span class="w">  </span><span class="n">gyroY</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">gyroYoffset</span><span class="p">;</span>
<span class="linenos">105</span><span class="w">  </span><span class="n">gyroZ</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">gyroZoffset</span><span class="p">;</span>
<span class="linenos">106</span><span class="w">  </span><span class="n">accX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">accXoffset</span><span class="p">;</span>
<span class="linenos">107</span><span class="w">  </span><span class="n">accY</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">accYoffset</span><span class="p">;</span>
<span class="linenos">108</span><span class="w">  </span><span class="n">accZ</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">accZoffset</span><span class="p">;</span>
<span class="linenos">109</span><span class="w">  </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">float</span><span class="p">)</span><span class="n">tempRaw</span><span class="p">;</span>
<span class="linenos">110</span><span class="w">  </span><span class="c1">// print data</span>
<span class="linenos">111</span><span class="w">  </span><span class="c1">//Serial.printf(&quot;AccX = %d, AccY = %d, AccZ = %d, Temp = &quot;, accX, accY, accZ);</span>
<span class="linenos">112</span><span class="w">  </span><span class="c1">//Serial.print(temp);</span>
<span class="linenos">113</span><span class="w">  </span><span class="c1">//Serial.printf(&quot;, GyroX = %d, GyroY = %d, GyroZ = %d\n&quot;, gyroX, gyroY, gyroZ);</span>
<span class="linenos">114</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Time = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">micros</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev</span><span class="p">);</span>
<span class="linenos">115</span><span class="w">  </span><span class="nf">delay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
<span class="linenos">116</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="motors-escs">
<h2>Motors + ESCs<a class="headerlink" href="#motors-escs" title="Permalink to this heading"></a></h2>
<p>After you have finished soldering all components on the PCB and soldered the motors in such manner Front Right Motor -&gt; CCW, Front Left Motor -&gt; CW, Bottom Right Motor -&gt; CW, Bottom Left Motor -&gt; CCW where CW means Clock Wise and CCW means Counter Clock Wise.
The way you can check the direction of rotation of each motor is by taking any AA or AAA battery and testing the motors by holding the wires of the poles of the battery. This will power the motor and you can use your finger to feel the direction of rotation.
In case the motors are spining in the wrong direction you can change the direction of rotation by switching the polarity of the motor connection to the PCB.
The PCB has two through-hole pad for each motor where the round pad indicates +ve terminal and square terminal indicates -ve/ground terminal.
When performing this test please do not attach the propellers to the motors for safety reason.
You can perform this test when powered via USB of the pi pico but it is prefered to power the PCB using the battery.</p>
<p>The motors are controlled by a PWM signal generated by using analog write command on digital pins.
The Mosfets act as a switch to rapidly switch the voltage and current from the battery to the motors
according to the PWM signal received.
The direction of rotation for the motors are same as YMFC or Pixhawk/Arducopter quadcopters i.e.
front right CCW, front left CW, bottom right CW and bottom left CCW. This script is not only useful to test the
motors but also test the direction of rotation of the motors.</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#define MOT_TOP_LEFT 18</span>
<span class="linenos"> 2</span><span class="cp">#define MOT_TOP_RIGHT 13</span>
<span class="linenos"> 3</span><span class="cp">#define MOT_BOTTOM_LEFT 28</span>
<span class="linenos"> 4</span><span class="cp">#define MOT_BOTTOM_RIGHT 1</span>
<span class="linenos"> 5</span><span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="c1">// put your setup code here, to run once:</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="n">analogWriteFreq</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span><span class="w"> </span><span class="c1">// PWM frequency 500 Hz</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="n">analogWriteRange</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">// value coresponding to 100% PWM duty cycle</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">MOT_TOP_LEFT</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos">11</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">MOT_TOP_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos">12</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">MOT_BOTTOM_LEFT</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos">13</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">MOT_BOTTOM_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos">14</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos">15</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_LEFT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">16</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">17</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_LEFT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">18</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">  </span><span class="c1">//Use the led on the Arduino for startup indication.</span>
<span class="linenos">21</span><span class="w">  </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="kr">HIGH</span><span class="p">);</span>
<span class="linenos">22</span><span class="p">}</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">25</span><span class="w">  </span><span class="c1">// put your main code here, to run repeatedly:</span>
<span class="linenos">26</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">27</span><span class="w">    </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">28</span><span class="w">    </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">29</span><span class="w">    </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_LEFT</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">30</span><span class="w">    </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_LEFT</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">31</span><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="linenos">32</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">33</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">-</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">-</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_LEFT</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">-</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">37</span><span class="w">    </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_LEFT</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">-</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">38</span><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="linenos">39</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">40</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="bmp280-not-yet-tested-or-used-in-flight-controller">
<h2>BMP280 (Not yet tested or used in flight controller)<a class="headerlink" href="#bmp280-not-yet-tested-or-used-in-flight-controller" title="Permalink to this heading"></a></h2>
<p>The BMP280 is a barometric pressure and temperature sensor. It is used for the altitude hold feature of the PicoW Copter.
The details for the i2c registers of the BMP280 sensor can be found in the data sheet along with the conversions.
I will suggest those who are interested to refer to the video by Carbon Aeronautics.
(This feature is not tested nor is included in flight controller yet but a script is provided for getting sensor data for PicoW)</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Wire.h&gt;</span>
<span class="linenos">  2</span><span class="cp">#define BMPAddress 0x76</span>
<span class="linenos">  3</span>
<span class="linenos">  4</span><span class="c1">// Barometer calibration values</span>
<span class="linenos">  5</span><span class="kr">uint16_t</span><span class="w"> </span><span class="n">dig_T1</span><span class="p">,</span><span class="w"> </span><span class="n">dig_P1</span><span class="p">;</span>
<span class="linenos">  6</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">dig_T2</span><span class="p">,</span><span class="w"> </span><span class="n">dig_T3</span><span class="p">,</span><span class="w"> </span><span class="n">dig_P2</span><span class="p">,</span><span class="w"> </span><span class="n">dig_P3</span><span class="p">,</span><span class="w"> </span><span class="n">dig_P4</span><span class="p">,</span><span class="w"> </span><span class="n">dig_P5</span><span class="p">;</span>
<span class="linenos">  7</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">dig_P6</span><span class="p">,</span><span class="w"> </span><span class="n">dig_P7</span><span class="p">,</span><span class="w"> </span><span class="n">dig_P8</span><span class="p">,</span><span class="w"> </span><span class="n">dig_P9</span><span class="p">;</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="c1">// Altitude variables</span>
<span class="linenos"> 10</span><span class="kr">float</span><span class="w"> </span><span class="n">AltitudeBarometer</span><span class="p">,</span><span class="w"> </span><span class="n">AltitudeBarometerStartUp</span><span class="p">;</span>
<span class="linenos"> 11</span><span class="kr">int</span><span class="w"> </span><span class="n">RateCalibrationNumber</span><span class="p">;</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span><span class="c1">// read barometer signal</span>
<span class="linenos"> 14</span><span class="kr">void</span><span class="w"> </span><span class="nf">barometer_signal</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 15</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">BMPAddress</span><span class="p">);</span>
<span class="linenos"> 16</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0xF7</span><span class="p">);</span>
<span class="linenos"> 17</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 18</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">requestFrom</span><span class="p">(</span><span class="n">BMPAddress</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
<span class="linenos"> 19</span><span class="w">  </span><span class="kr">uint32_t</span><span class="w"> </span><span class="n">press_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w"> </span><span class="c1">// 0xF7</span>
<span class="linenos"> 20</span><span class="w">  </span><span class="kr">uint32_t</span><span class="w"> </span><span class="n">press_lsb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w"> </span><span class="c1">// 0xF8</span>
<span class="linenos"> 21</span><span class="w">  </span><span class="kr">uint32_t</span><span class="w"> </span><span class="n">press_xlsb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 22</span><span class="w">  </span><span class="kr">uint32_t</span><span class="w"> </span><span class="n">temp_msb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 23</span><span class="w">  </span><span class="kr">uint32_t</span><span class="w"> </span><span class="n">temp_lsb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 24</span><span class="w">  </span><span class="kr">uint32_t</span><span class="w"> </span><span class="n">temp_xlsb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w"> </span><span class="c1">// 0xFC</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="w">  </span><span class="c1">// Construct raw temperature and pressure measurements</span>
<span class="linenos"> 27</span><span class="w">  </span><span class="c1">// msb contans bits [19-12], lsb contains bits [11-4], and xlsb contains bits [3-0]</span>
<span class="linenos"> 28</span><span class="w">  </span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">adc_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">press_msb</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">press_lsb</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">press_xlsb</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">);</span>
<span class="linenos"> 29</span><span class="w">  </span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">adc_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">temp_msb</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">temp_lsb</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">temp_xlsb</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">);</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="w">  </span><span class="c1">// Construct fine resolution temperature value</span>
<span class="linenos"> 32</span><span class="w">  </span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="n">var2</span><span class="p">;</span>
<span class="linenos"> 33</span><span class="w">  </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((((</span><span class="n">adc_T</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_T1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_T2</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">11</span><span class="p">;</span>
<span class="linenos"> 34</span><span class="w">  </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((((</span><span class="n">adc_T</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_T1</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">adc_T</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_T1</span><span class="p">)))</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_T3</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">14</span><span class="p">;</span>
<span class="linenos"> 35</span><span class="w">  </span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">t_fine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">var2</span><span class="p">;</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="w">  </span><span class="c1">// Construct the compensated and calibrated pressure p according to manufacturer</span>
<span class="linenos"> 38</span><span class="w">  </span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="linenos"> 39</span><span class="w">  </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">t_fine</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="mi">64000</span><span class="p">;</span>
<span class="linenos"> 40</span><span class="w">  </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="n">var1</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">var1</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">11</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_P6</span><span class="p">);</span>
<span class="linenos"> 41</span><span class="w">  </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">var1</span><span class="o">*</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_P5</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 42</span><span class="w">  </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">var2</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_P4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
<span class="linenos"> 43</span><span class="w">  </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="n">dig_P3</span><span class="o">*</span><span class="p">(((</span><span class="n">var1</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">var1</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="p">((((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_P2</span><span class="p">)</span><span class="o">*</span><span class="n">var1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">18</span><span class="p">;</span>
<span class="linenos"> 44</span><span class="w">  </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((((</span><span class="mi">32768</span><span class="o">+</span><span class="n">var1</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_P1</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">);</span>
<span class="linenos"> 45</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">var1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 46</span><span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)(((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="mi">1048576</span><span class="p">)</span><span class="o">-</span><span class="n">adc_P</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">var2</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">)))</span><span class="o">*</span><span class="mi">3125</span><span class="p">;</span>
<span class="linenos"> 47</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mh">0x80000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">((</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">var1</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 48</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 49</span><span class="w">  </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_P9</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)(((</span><span class="n">p</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">)))</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">;</span>
<span class="linenos"> 50</span><span class="w">  </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)(</span><span class="n">p</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">dig_P8</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">;</span>
<span class="linenos"> 51</span><span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)((</span><span class="kr">signed</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="kr">int</span><span class="p">)</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">var1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dig_P7</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">));</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="w">  </span><span class="kr">double</span><span class="w"> </span><span class="n">pressure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kr">double</span><span class="p">)</span><span class="n">p</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span><span class="w">  </span><span class="c1">// pressure in hPa</span>
<span class="linenos"> 54</span><span class="w">  </span><span class="n">AltitudeBarometer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">44330</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nf">pow</span><span class="p">(</span><span class="n">pressure</span><span class="o">/</span><span class="mf">1013.25</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mf">5.255</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="c1">// Altitude in cm</span>
<span class="linenos"> 55</span><span class="p">}</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 58</span><span class="w">  </span><span class="c1">// BMP280 setup</span>
<span class="linenos"> 59</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">57600</span><span class="p">);</span>
<span class="linenos"> 60</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos"> 61</span><span class="w">  </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="kr">HIGH</span><span class="p">);</span>
<span class="linenos"> 62</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="n">setClock</span><span class="p">(</span><span class="mi">400000</span><span class="p">);</span>
<span class="linenos"> 63</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">begin</span><span class="p">();</span>
<span class="linenos"> 64</span><span class="w">  </span><span class="nf">delay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="w">  </span><span class="c1">// Setup BMP280 barometer optimized for indoor navigation</span>
<span class="linenos"> 67</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">BMPAddress</span><span class="p">);</span>
<span class="linenos"> 68</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0xF4</span><span class="p">);</span><span class="w"> </span><span class="c1">// measurement register setup for indoor mode</span>
<span class="linenos"> 69</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x57</span><span class="p">);</span><span class="w"> </span><span class="c1">// normal mode, pressure oversampling x16 temperature oversampling x2</span>
<span class="linenos"> 70</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 71</span><span class="w">  </span><span class="c1">// Setup configuration register</span>
<span class="linenos"> 72</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">BMPAddress</span><span class="p">);</span>
<span class="linenos"> 73</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0xF5</span><span class="p">);</span>
<span class="linenos"> 74</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x14</span><span class="p">);</span><span class="w"> </span><span class="c1">// IIR filter coefficient 16 rest are 0</span>
<span class="linenos"> 75</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 76</span><span class="w">  </span><span class="c1">// Importing 12 trimming parameters from sensor</span>
<span class="linenos"> 77</span><span class="w">  </span><span class="kr">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 78</span><span class="w">  </span><span class="c1">// First trimming parameter</span>
<span class="linenos"> 79</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">BMPAddress</span><span class="p">);</span>
<span class="linenos"> 80</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x88</span><span class="p">);</span>
<span class="linenos"> 81</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span>
<span class="linenos"> 82</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">requestFrom</span><span class="p">(</span><span class="n">BMPAddress</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">);</span><span class="w"> </span><span class="c1">// 24 bytes of data from register 0x88 to 0x9F</span>
<span class="linenos"> 83</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">available</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="linenos"> 86</span><span class="w">  </span><span class="p">}</span>
<span class="linenos"> 87</span><span class="w">  </span><span class="n">dig_T1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos"> 88</span><span class="w">  </span><span class="n">dig_T2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos"> 89</span><span class="w">  </span><span class="n">dig_T3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos"> 90</span><span class="w">  </span><span class="n">dig_P1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="linenos"> 91</span><span class="w">  </span><span class="n">dig_P2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="linenos"> 92</span><span class="w">  </span><span class="n">dig_P3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="linenos"> 93</span><span class="w">  </span><span class="n">dig_P4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<span class="linenos"> 94</span><span class="w">  </span><span class="n">dig_P5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
<span class="linenos"> 95</span><span class="w">  </span><span class="n">dig_P6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="linenos"> 96</span><span class="w">  </span><span class="n">dig_P7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
<span class="linenos"> 97</span><span class="w">  </span><span class="n">dig_P8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<span class="linenos"> 98</span><span class="w">  </span><span class="n">dig_P9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>
<span class="linenos"> 99</span><span class="w">  </span><span class="nf">delay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
<span class="linenos">100</span><span class="w">  </span><span class="c1">// barometer calibration calculating altitude reference level</span>
<span class="linenos">101</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">RateCalibrationNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">RateCalibrationNumber</span><span class="o">&lt;</span><span class="mi">2000</span><span class="p">;</span><span class="w"> </span><span class="n">RateCalibrationNumber</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">102</span><span class="w">    </span><span class="n">barometer_signal</span><span class="p">();</span>
<span class="linenos">103</span><span class="w">    </span><span class="n">AltitudeBarometerStartUp</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">AltitudeBarometer</span><span class="p">;</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">105</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">106</span><span class="w">  </span><span class="n">AltitudeBarometerStartUp</span><span class="o">/=</span><span class="mi">2000</span><span class="p">;</span>
<span class="linenos">107</span><span class="p">}</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">110</span><span class="w">  </span><span class="c1">// Read the barometer and print altitudes</span>
<span class="linenos">111</span><span class="w">  </span><span class="n">barometer_signal</span><span class="p">();</span>
<span class="linenos">112</span><span class="w">  </span><span class="n">AltitudeBarometer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AltitudeBarometerStartUp</span><span class="p">;</span>
<span class="linenos">113</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;Altitude [cm]:&quot;</span><span class="p">);</span>
<span class="linenos">114</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="n">AltitudeBarometer</span><span class="p">);</span>
<span class="linenos">115</span><span class="w">  </span><span class="nf">delay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="linenos">116</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="battery-voltage">
<h2>Battery voltage<a class="headerlink" href="#battery-voltage" title="Permalink to this heading"></a></h2>
<p>While flying any quadcopter it is important to keep track of the battery voltage. The battery is a 1S Lipo 360mAh Battery
and it is important to be careful when using Lipo batteries in any project as special care needs to be taken to prevent
over discharge (while flying) and over charge (while charging). If you Lipo looks swollen it is recommended to dispose it in
a controlled manner as provided by the manufacturer i.e. first using a large resistance to slowly discharge the Lipo completely and slowly and then burrying it.
It is highly prefered to dispose Lithium batteries through some professional recycling service as They are can have long term environmental impacts
as according to this article ((Go to Pg 4 last para))[<a class="reference external" href="https://www.intertek.com/uploadedFiles/Intertek/Divisions/Commercial_and_Electrical/Media/PDF/Battery/Environmental-Considerations-for-Lithium-Batteries-White-Paper.pdf">https://www.intertek.com/uploadedFiles/Intertek/Divisions/Commercial_and_Electrical/Media/PDF/Battery/Environmental-Considerations-for-Lithium-Batteries-White-Paper.pdf</a>]
LION do have some heavy metals like Cobalt, Copper and Nickle so I assume Lipo batteries also have these metals and if burried they can reach into the ground
water to cause heavy metal poisoning but I am not an expert on this topic so I request anyone interested to do their own research.</p>
<p>This script reads the battery voltage from the A0 pin and sends the reading over WiFi using UDP to another device.</p>
</section>
</section>
<section id="software">
<h1>Software<a class="headerlink" href="#software" title="Permalink to this heading"></a></h1>
<p>The main software contains the flight controller. The flight controller is the complete quadcopter code. This code was tested on 21-05-2023.
once you upload the code dsiconnect the pico and keep it in a spacious room on a flat surface. Now plug in the Lipo battery to start the gyro clibration process as shown by fast blinking LED.
Once the LED starts blinking on your smartphone connect to the PicoW hotspot using the password “password”.
Now that you have connected the blinking must have stopped. To setup the controls go to the UDP joystick App and enter the IP address 192.168.42.1, port 8888 and rate of 20ms.
Once done tap the button such that it says “ON” to indicate that the App has started and switch to the screen with joysticks.
Now the way you start/ARM the quadcopter is by pulling the throttle joystick (left one) down to zero, moving it to the bottom left corner and back to the bottom center.
The way you stop/DISARM the quadcopter is by bringing the throttle joystick to the bottom right anf back to center.
This code is inspired from YMFC-AL project by Joop Brokking. For more details on PID controller please do refer to his playlist over on YouTube.</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Wire.h&gt;</span><span class="c1">                          //Include the Wire.h library so we can communicate with the gyro.</span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFi.h&gt;</span>
<span class="linenos">  3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFiUdp.h&gt;</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="cp">#define I2C_CLK_FREQ 400000 </span><span class="c1">// 400kHz</span>
<span class="linenos">  6</span><span class="kr">const</span><span class="w"> </span><span class="n">u_int8_t</span><span class="w"> </span><span class="n">IMUAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x68</span><span class="p">;</span><span class="w">  </span><span class="c1">// Address for MPU6050 IMU sensor</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="cp">#ifndef APSSID</span>
<span class="linenos">  9</span><span class="cp">#define APSSID &quot;PicoW&quot;</span>
<span class="linenos"> 10</span><span class="cp">#define APPSW &quot;password&quot;</span>
<span class="linenos"> 11</span><span class="cp">#endif</span>
<span class="linenos"> 12</span><span class="cp">#define UDP_PKT_MAX_SIZE 16</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">localPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8888</span><span class="p">;</span>
<span class="linenos"> 15</span><span class="kr">char</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">UDP_PKT_MAX_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span><span class="nf">WiFiUDP</span><span class="w"> </span><span class="n">Udp</span><span class="p">;</span><span class="w">  </span><span class="c1">// Object for WiFi UDP class</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="cp">#define MOT_TOP_LEFT 18</span>
<span class="linenos"> 20</span><span class="cp">#define MOT_TOP_RIGHT 13</span>
<span class="linenos"> 21</span><span class="cp">#define MOT_BOTTOM_LEFT 28</span>
<span class="linenos"> 22</span><span class="cp">#define MOT_BOTTOM_RIGHT 1</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 25</span><span class="c1">//PID gain and limit settings</span>
<span class="linenos"> 26</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 27</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_p_gain_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.05</span><span class="p">;</span><span class="w">               </span><span class="c1">//Gain setting for the roll P-controller</span>
<span class="linenos"> 28</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_i_gain_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.013</span><span class="p">;</span><span class="w">              </span><span class="c1">//Gain setting for the roll I-controller 0.04</span>
<span class="linenos"> 29</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_d_gain_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">11.0</span><span class="p">;</span><span class="w">              </span><span class="c1">//Gain setting for the roll D-controller</span>
<span class="linenos"> 30</span><span class="kr">int</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span><span class="w">                    </span><span class="c1">//Maximum output of the PID-controller (+/-)</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_p_gain_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_p_gain_roll</span><span class="p">;</span><span class="w">  </span><span class="c1">//Gain setting for the pitch P-controller.</span>
<span class="linenos"> 33</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_i_gain_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_i_gain_roll</span><span class="p">;</span><span class="w">  </span><span class="c1">//Gain setting for the pitch I-controller.</span>
<span class="linenos"> 34</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_d_gain_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_d_gain_roll</span><span class="p">;</span><span class="w">  </span><span class="c1">//Gain setting for the pitch D-controller.</span>
<span class="linenos"> 35</span><span class="kr">int</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="p">;</span><span class="w">          </span><span class="c1">//Maximum output of the PID-controller (+/-)</span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_p_gain_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8.5</span><span class="p">;</span><span class="w">                </span><span class="c1">//Gain setting for the pitch P-controller. //4.0</span>
<span class="linenos"> 38</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_i_gain_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.005</span><span class="p">;</span><span class="w">               </span><span class="c1">//Gain setting for the pitch I-controller. //0.02</span>
<span class="linenos"> 39</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_d_gain_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">                </span><span class="c1">//Gain setting for the pitch D-controller.</span>
<span class="linenos"> 40</span><span class="kr">int</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span><span class="w">                     </span><span class="c1">//Maximum output of the PID-controller (+/-)</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="kr">boolean</span><span class="w"> </span><span class="n">auto_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">true</span><span class="p">;</span><span class="w">                 </span><span class="c1">//Auto level on (true) or off (false)</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 45</span><span class="c1">//Declaring global variables</span>
<span class="linenos"> 46</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 47</span><span class="kr">byte</span><span class="w"> </span><span class="n">last_channel_1</span><span class="p">,</span><span class="w"> </span><span class="n">last_channel_2</span><span class="p">,</span><span class="w"> </span><span class="n">last_channel_3</span><span class="p">,</span><span class="w"> </span><span class="n">last_channel_4</span><span class="p">;</span>
<span class="linenos"> 48</span><span class="kr">byte</span><span class="w"> </span><span class="nf">highByte</span><span class="p">,</span><span class="w"> </span><span class="nf">lowByte</span><span class="p">;</span>
<span class="linenos"> 49</span><span class="kr">volatile</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">receiver_input_channel_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">receiver_input_channel_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 50</span><span class="kr">int</span><span class="w"> </span><span class="n">counter_channel_1</span><span class="p">,</span><span class="w"> </span><span class="n">counter_channel_2</span><span class="p">,</span><span class="w"> </span><span class="n">counter_channel_3</span><span class="p">,</span><span class="w"> </span><span class="n">counter_channel_4</span><span class="p">,</span><span class="w"> </span><span class="n">loop_counter</span><span class="p">;</span>
<span class="linenos"> 51</span><span class="kr">int</span><span class="w"> </span><span class="n">esc_1</span><span class="p">,</span><span class="w"> </span><span class="n">esc_2</span><span class="p">,</span><span class="w"> </span><span class="n">esc_3</span><span class="p">,</span><span class="w"> </span><span class="n">esc_4</span><span class="p">;</span>
<span class="linenos"> 52</span><span class="kr">int</span><span class="w"> </span><span class="n">throttle</span><span class="p">,</span><span class="w"> </span><span class="n">battery_voltage</span><span class="p">;</span>
<span class="linenos"> 53</span><span class="kr">int</span><span class="w"> </span><span class="n">cal_int</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">gyro_address</span><span class="p">;</span>
<span class="linenos"> 54</span><span class="kr">int</span><span class="w"> </span><span class="n">receiver_input</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="linenos"> 55</span><span class="kr">int</span><span class="w"> </span><span class="n">temperature</span><span class="p">;</span>
<span class="linenos"> 56</span><span class="kr">int16_t</span><span class="w"> </span><span class="n">acc_axis</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos"> 57</span><span class="kr">float</span><span class="w"> </span><span class="n">roll_level_adjust</span><span class="p">,</span><span class="w"> </span><span class="n">pitch_level_adjust</span><span class="p">;</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="kr">long</span><span class="w"> </span><span class="n">acc_x</span><span class="p">,</span><span class="w"> </span><span class="n">acc_y</span><span class="p">,</span><span class="w"> </span><span class="n">acc_z</span><span class="p">,</span><span class="w"> </span><span class="n">acc_total_vector</span><span class="p">;</span>
<span class="linenos"> 60</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="n">timer_channel_1</span><span class="p">,</span><span class="w"> </span><span class="n">timer_channel_2</span><span class="p">,</span><span class="w"> </span><span class="n">timer_channel_3</span><span class="p">,</span><span class="w"> </span><span class="n">timer_channel_4</span><span class="p">,</span><span class="w"> </span><span class="n">esc_timer</span><span class="p">,</span><span class="w"> </span><span class="n">esc_loop_timer</span><span class="p">;</span>
<span class="linenos"> 61</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="n">timer_1</span><span class="p">,</span><span class="w"> </span><span class="n">timer_2</span><span class="p">,</span><span class="w"> </span><span class="n">timer_3</span><span class="p">,</span><span class="w"> </span><span class="n">timer_4</span><span class="p">,</span><span class="w"> </span><span class="n">current_time</span><span class="p">;</span>
<span class="linenos"> 62</span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">long</span><span class="w"> </span><span class="n">loop_timer</span><span class="p">;</span>
<span class="linenos"> 63</span><span class="kr">double</span><span class="w"> </span><span class="n">gyro_pitch</span><span class="p">,</span><span class="w"> </span><span class="n">gyro_roll</span><span class="p">,</span><span class="w"> </span><span class="n">gyro_yaw</span><span class="p">;</span>
<span class="linenos"> 64</span><span class="kr">double</span><span class="w"> </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos"> 65</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="p">;</span>
<span class="linenos"> 66</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_i_mem_roll</span><span class="p">,</span><span class="w"> </span><span class="n">pid_roll_setpoint</span><span class="p">,</span><span class="w"> </span><span class="n">gyro_roll_input</span><span class="p">,</span><span class="w"> </span><span class="n">pid_output_roll</span><span class="p">,</span><span class="w"> </span><span class="n">pid_last_roll_d_error</span><span class="p">;</span>
<span class="linenos"> 67</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_i_mem_pitch</span><span class="p">,</span><span class="w"> </span><span class="n">pid_pitch_setpoint</span><span class="p">,</span><span class="w"> </span><span class="n">gyro_pitch_input</span><span class="p">,</span><span class="w"> </span><span class="n">pid_output_pitch</span><span class="p">,</span><span class="w"> </span><span class="n">pid_last_pitch_d_error</span><span class="p">;</span>
<span class="linenos"> 68</span><span class="kr">float</span><span class="w"> </span><span class="n">pid_i_mem_yaw</span><span class="p">,</span><span class="w"> </span><span class="n">pid_yaw_setpoint</span><span class="p">,</span><span class="w"> </span><span class="n">gyro_yaw_input</span><span class="p">,</span><span class="w"> </span><span class="n">pid_output_yaw</span><span class="p">,</span><span class="w"> </span><span class="n">pid_last_yaw_d_error</span><span class="p">;</span>
<span class="linenos"> 69</span><span class="kr">float</span><span class="w"> </span><span class="n">angle_roll_acc</span><span class="p">,</span><span class="w"> </span><span class="n">angle_pitch_acc</span><span class="p">,</span><span class="w"> </span><span class="n">angle_pitch</span><span class="p">,</span><span class="w"> </span><span class="n">angle_roll</span><span class="p">;</span>
<span class="linenos"> 70</span><span class="kr">boolean</span><span class="w"> </span><span class="n">gyro_angles_set</span><span class="p">;</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 73</span><span class="c1">//Setup routine</span>
<span class="linenos"> 74</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 75</span><span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">(){</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="w">  </span><span class="n">analogWriteFreq</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span><span class="w"> </span><span class="c1">// PWM frequency 500 Hz</span>
<span class="linenos"> 78</span><span class="w">  </span><span class="n">analogWriteRange</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">// value coresponding to 100% PWM duty cycle</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="linenos"> 81</span><span class="w">  </span><span class="n">gyro_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IMUAddress</span><span class="p">;</span>
<span class="linenos"> 82</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="n">setClock</span><span class="p">(</span><span class="n">I2C_CLK_FREQ</span><span class="p">);</span>
<span class="linenos"> 83</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">begin</span><span class="p">();</span><span class="w">                                                             </span><span class="c1">//Start the I2C as master.</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">MOT_TOP_LEFT</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos"> 86</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">MOT_TOP_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos"> 87</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">MOT_BOTTOM_LEFT</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos"> 88</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">MOT_BOTTOM_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos"> 89</span><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span>
<span class="linenos"> 90</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_LEFT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 91</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 92</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_LEFT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 93</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span><span class="w">  </span><span class="c1">//Use the led on the Arduino for startup indication.</span>
<span class="linenos"> 96</span><span class="w">  </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="kr">HIGH</span><span class="p">);</span><span class="w">                                                    </span><span class="c1">//Turn on the warning led.</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="w">  </span><span class="n">set_gyro_registers</span><span class="p">();</span><span class="w">                                                     </span><span class="c1">//Set the specific gyro registers.</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="w">  </span><span class="c1">//Let&#39;s take multiple gyro data samples so we can determine the average gyro offset (calibration).</span>
<span class="linenos">101</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cal_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">cal_int</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2000</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">cal_int</span><span class="w"> </span><span class="o">++</span><span class="p">){</span><span class="w">                           </span><span class="c1">//Take 2000 readings for calibration.</span>
<span class="linenos">102</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">cal_int</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">103</span><span class="w">      </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="nf">digitalRead</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">));</span><span class="w">                </span><span class="c1">//Change the led status to indicate calibration.</span>
<span class="linenos">104</span><span class="w">    </span><span class="n">gyro_signalen</span><span class="p">();</span><span class="w">                                                        </span><span class="c1">//Read the gyro output.</span>
<span class="linenos">105</span><span class="w">    </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">106</span><span class="w">    </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">107</span><span class="w">    </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w">                                                               </span><span class="c1">//Wait 3 milliseconds before the next loop.</span>
<span class="linenos">109</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">110</span><span class="w">  </span><span class="c1">//Now that we have 2000 measures, we need to devide by 2000 to get the average gyro offset.</span>
<span class="linenos">111</span><span class="w">  </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">                                                 </span><span class="c1">//Divide the roll total by 2000.</span>
<span class="linenos">112</span><span class="w">  </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">                                                 </span><span class="c1">//Divide the pitch total by 2000.</span>
<span class="linenos">113</span><span class="w">  </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">                                                 </span><span class="c1">//Divide the yaw total by 2000.                                                //Set PCINT3 (digital input 11)to trigger an interrupt on state change.</span>
<span class="linenos">114</span>
<span class="linenos">115</span><span class="w">  </span><span class="nf">WiFi</span><span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="n">WIFI_AP</span><span class="p">);</span>
<span class="linenos">116</span><span class="w">  </span><span class="nf">WiFi</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="n">APSSID</span><span class="p">,</span><span class="w"> </span><span class="n">APPSW</span><span class="p">);</span>
<span class="linenos">117</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nf">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">WL_CONNECTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">);</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="linenos">120</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">121</span><span class="w">  </span><span class="n">Udp</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="n">localPort</span><span class="p">);</span>
<span class="linenos">122</span><span class="w">  </span><span class="c1">//Wait until the receiver is active and the throtle is set to the lower position.</span>
<span class="linenos">123</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">990</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1020</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1400</span><span class="p">){</span>
<span class="linenos">124</span><span class="w">    </span><span class="kr">int</span><span class="w"> </span><span class="n">packetSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Udp</span><span class="p">.</span><span class="nf">parsePacket</span><span class="p">();</span>
<span class="linenos">125</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">packetSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">126</span><span class="w">      </span><span class="kr">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Udp</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UDP_PKT_MAX_SIZE</span><span class="p">);</span>
<span class="linenos">127</span><span class="w">      </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">128</span><span class="w">      </span><span class="kr">char</span><span class="w"> </span><span class="n">ch1</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch2</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch3</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch4</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="linenos">129</span><span class="w">      </span><span class="n">ch1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch3</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch4</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">130</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">131</span><span class="w">        </span><span class="n">ch4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">132</span><span class="w">        </span><span class="n">ch3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos">133</span><span class="w">        </span><span class="n">ch1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">];</span>
<span class="linenos">134</span><span class="w">        </span><span class="n">ch2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">];</span>
<span class="linenos">135</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">136</span><span class="w">      </span><span class="n">receiver_input_channel_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch1</span><span class="p">);</span><span class="w"> </span><span class="c1">// ROLL</span>
<span class="linenos">137</span><span class="w">      </span><span class="n">receiver_input_channel_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch2</span><span class="p">);</span><span class="w"> </span><span class="c1">// PITCH</span>
<span class="linenos">138</span><span class="w">      </span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch3</span><span class="p">);</span><span class="w"> </span><span class="c1">// THROTTLE</span>
<span class="linenos">139</span><span class="w">      </span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch4</span><span class="p">);</span><span class="w"> </span><span class="c1">// YAW</span>
<span class="linenos">140</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">141</span><span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
<span class="linenos">142</span><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w">                                                               </span><span class="c1">//Wait 3 milliseconds before the next loop.</span>
<span class="linenos">143</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">125</span><span class="p">){</span><span class="w">                                                       </span><span class="c1">//Every 125 loops (500ms).</span>
<span class="linenos">144</span><span class="w">      </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="nf">digitalRead</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">));</span><span class="w">                                   </span><span class="c1">//Change the led status.</span>
<span class="linenos">145</span><span class="w">      </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                                                            </span><span class="c1">//Start again at 0.</span>
<span class="linenos">146</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">147</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">148</span><span class="w">  </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                                                                </span><span class="c1">//Set start back to 0.</span>
<span class="linenos">149</span>
<span class="linenos">150</span><span class="w">  </span><span class="c1">//Load the battery voltage to the battery_voltage variable.</span>
<span class="linenos">151</span><span class="w">  </span><span class="c1">//65 is the voltage compensation for the diode.</span>
<span class="linenos">152</span><span class="w">  </span><span class="c1">//12.6V equals ~5V @ Analog 0.</span>
<span class="linenos">153</span><span class="w">  </span><span class="c1">//12.6V equals 1023 analogRead(0).</span>
<span class="linenos">154</span><span class="w">  </span><span class="c1">//1260 / 1023 = 1.2317.</span>
<span class="linenos">155</span><span class="w">  </span><span class="c1">//The variable battery_voltage holds 1050 if the battery voltage is 10.5V.</span>
<span class="linenos">156</span><span class="w">  </span><span class="c1">//battery_voltage = (analogRead(0) + 65) * 1.2317;</span>
<span class="linenos">157</span>
<span class="linenos">158</span><span class="w">  </span><span class="n">loop_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">micros</span><span class="p">();</span><span class="w">                                                    </span><span class="c1">//Set the timer for the next loop.</span>
<span class="linenos">159</span>
<span class="linenos">160</span><span class="w">  </span><span class="c1">//When everything is done, turn off the led.</span>
<span class="linenos">161</span><span class="w">  </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="kr">LOW</span><span class="p">);</span><span class="w">                                                     </span><span class="c1">//Turn off the warning led.</span>
<span class="linenos">162</span><span class="p">}</span>
<span class="linenos">163</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">164</span><span class="c1">//Main program loop</span>
<span class="linenos">165</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">166</span><span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">(){</span>
<span class="linenos">167</span><span class="w">  </span><span class="kr">int</span><span class="w"> </span><span class="n">packetSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Udp</span><span class="p">.</span><span class="nf">parsePacket</span><span class="p">();</span>
<span class="linenos">168</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">packetSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">169</span><span class="w">      </span><span class="kr">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Udp</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UDP_PKT_MAX_SIZE</span><span class="p">);</span>
<span class="linenos">170</span><span class="w">      </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">171</span><span class="w">      </span><span class="kr">char</span><span class="w"> </span><span class="n">ch1</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch2</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch3</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch4</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="linenos">172</span><span class="w">      </span><span class="n">ch1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch3</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch4</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">173</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">174</span><span class="w">        </span><span class="n">ch4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">175</span><span class="w">        </span><span class="n">ch3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos">176</span><span class="w">        </span><span class="n">ch1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">];</span>
<span class="linenos">177</span><span class="w">        </span><span class="n">ch2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">];</span>
<span class="linenos">178</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">179</span><span class="w">      </span><span class="n">receiver_input_channel_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch1</span><span class="p">);</span><span class="w"> </span><span class="c1">// ROLL</span>
<span class="linenos">180</span><span class="w">      </span><span class="n">receiver_input_channel_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch2</span><span class="p">);</span><span class="w"> </span><span class="c1">// PITCH</span>
<span class="linenos">181</span><span class="w">      </span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch3</span><span class="p">);</span><span class="w"> </span><span class="c1">// THROTTLE</span>
<span class="linenos">182</span><span class="w">      </span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch4</span><span class="p">);</span><span class="w"> </span><span class="c1">// YAW</span>
<span class="linenos">183</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">184</span>
<span class="linenos">185</span><span class="w">  </span><span class="c1">//65.5 = 1 deg/sec (check the datasheet of the MPU-6050 for more information).</span>
<span class="linenos">186</span><span class="w">  </span><span class="n">gyro_roll_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gyro_roll_input</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">gyro_roll</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">65.5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span><span class="w">   </span><span class="c1">//Gyro pid input is deg/sec.</span>
<span class="linenos">187</span><span class="w">  </span><span class="n">gyro_pitch_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gyro_pitch_input</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">gyro_pitch</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">65.5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span><span class="c1">//Gyro pid input is deg/sec.</span>
<span class="linenos">188</span><span class="w">  </span><span class="n">gyro_yaw_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gyro_yaw_input</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">gyro_yaw</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">65.5</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span><span class="w">      </span><span class="c1">//Gyro pid input is deg/sec.</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="c1">//  Serial.print(gyro_roll_input);</span>
<span class="linenos">191</span><span class="c1">//  Serial.print(&quot;, &quot;);</span>
<span class="linenos">192</span><span class="c1">//  Serial.print(gyro_pitch_input);</span>
<span class="linenos">193</span><span class="c1">//  Serial.print(&quot;, &quot;);</span>
<span class="linenos">194</span><span class="c1">//  Serial.print(gyro_yaw_input);</span>
<span class="linenos">195</span><span class="c1">//  Serial.println();</span>
<span class="linenos">196</span><span class="c1">//</span>
<span class="linenos">197</span>
<span class="linenos">198</span><span class="w">  </span><span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">199</span><span class="w">  </span><span class="c1">//This is the added IMU code from the videos:</span>
<span class="linenos">200</span><span class="w">  </span><span class="c1">//https://youtu.be/4BoIE8YQwM8</span>
<span class="linenos">201</span><span class="w">  </span><span class="c1">//https://youtu.be/j-kE0AMEWy4</span>
<span class="linenos">202</span><span class="w">  </span><span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="w">  </span><span class="c1">//Gyro angle calculations</span>
<span class="linenos">205</span><span class="w">  </span><span class="c1">//0.0000611 = 1 / (250Hz / 65.5)</span>
<span class="linenos">206</span><span class="w">  </span><span class="n">angle_pitch</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gyro_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.0000611</span><span class="p">;</span><span class="w">                                    </span><span class="c1">//Calculate the traveled pitch angle and add this to the angle_pitch variable.</span>
<span class="linenos">207</span><span class="w">  </span><span class="n">angle_roll</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gyro_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.0000611</span><span class="p">;</span><span class="w">                                      </span><span class="c1">//Calculate the traveled roll angle and add this to the angle_roll variable.</span>
<span class="linenos">208</span>
<span class="linenos">209</span><span class="w">  </span><span class="c1">//0.000001066 = 0.0000611 * (3.142(PI) / 180degr) The Arduino sin function is in radians</span>
<span class="linenos">210</span><span class="w">  </span><span class="n">angle_pitch</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">angle_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sin</span><span class="p">(</span><span class="n">gyro_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.000001066</span><span class="p">);</span><span class="w">                  </span><span class="c1">//If the IMU has yawed transfer the roll angle to the pitch angel.</span>
<span class="linenos">211</span><span class="w">  </span><span class="n">angle_roll</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">angle_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sin</span><span class="p">(</span><span class="n">gyro_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.000001066</span><span class="p">);</span><span class="w">                  </span><span class="c1">//If the IMU has yawed transfer the pitch angle to the roll angel.</span>
<span class="linenos">212</span>
<span class="linenos">213</span><span class="w">  </span><span class="c1">//Accelerometer angle calculations</span>
<span class="linenos">214</span><span class="w">  </span><span class="n">acc_total_vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">((</span><span class="n">acc_x</span><span class="o">*</span><span class="n">acc_x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">acc_y</span><span class="o">*</span><span class="n">acc_y</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">acc_z</span><span class="o">*</span><span class="n">acc_z</span><span class="p">));</span><span class="w">       </span><span class="c1">//Calculate the total accelerometer vector.</span>
<span class="linenos">215</span>
<span class="linenos">216</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">acc_y</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">acc_total_vector</span><span class="p">){</span><span class="w">                                        </span><span class="c1">//Prevent the asin function to produce a NaN</span>
<span class="linenos">217</span><span class="w">    </span><span class="n">angle_pitch_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asin</span><span class="p">((</span><span class="kr">float</span><span class="p">)</span><span class="n">acc_y</span><span class="o">/</span><span class="n">acc_total_vector</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="mf">57.296</span><span class="p">;</span><span class="w">          </span><span class="c1">//Calculate the pitch angle.</span>
<span class="linenos">218</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">219</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">acc_x</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">acc_total_vector</span><span class="p">){</span><span class="w">                                        </span><span class="c1">//Prevent the asin function to produce a NaN</span>
<span class="linenos">220</span><span class="w">    </span><span class="n">angle_roll_acc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asin</span><span class="p">((</span><span class="kr">float</span><span class="p">)</span><span class="n">acc_x</span><span class="o">/</span><span class="n">acc_total_vector</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="mf">-57.296</span><span class="p">;</span><span class="w">          </span><span class="c1">//Calculate the roll angle.</span>
<span class="linenos">221</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">222</span>
<span class="linenos">223</span><span class="w">  </span><span class="c1">//Place the MPU-6050 spirit level and note the values in the following two lines for calibration.</span>
<span class="linenos">224</span><span class="w">  </span><span class="n">angle_pitch_acc</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">                                                   </span><span class="c1">//Accelerometer calibration value for pitch.</span>
<span class="linenos">225</span><span class="w">  </span><span class="n">angle_roll_acc</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w">                                                    </span><span class="c1">//Accelerometer calibration value for roll.</span>
<span class="linenos">226</span>
<span class="linenos">227</span><span class="w">  </span><span class="n">angle_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angle_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.9996</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">angle_pitch_acc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.0004</span><span class="p">;</span><span class="w">            </span><span class="c1">//Correct the drift of the gyro pitch angle with the accelerometer pitch angle.</span>
<span class="linenos">228</span><span class="w">  </span><span class="n">angle_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angle_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.9996</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">angle_roll_acc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.0004</span><span class="p">;</span><span class="w">               </span><span class="c1">//Correct the drift of the gyro roll angle with the accelerometer roll angle.</span>
<span class="linenos">229</span>
<span class="linenos">230</span><span class="w">  </span><span class="n">pitch_level_adjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angle_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span><span class="w">                                    </span><span class="c1">//Calculate the pitch angle correction</span>
<span class="linenos">231</span><span class="w">  </span><span class="n">roll_level_adjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angle_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span><span class="w">                                      </span><span class="c1">//Calculate the roll angle correction</span>
<span class="linenos">232</span>
<span class="linenos">233</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">auto_level</span><span class="p">){</span><span class="w">                                                          </span><span class="c1">//If the quadcopter is not in auto-level mode</span>
<span class="linenos">234</span><span class="w">    </span><span class="n">pitch_level_adjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                                                 </span><span class="c1">//Set the pitch angle correction to zero.</span>
<span class="linenos">235</span><span class="w">    </span><span class="n">roll_level_adjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                                                  </span><span class="c1">//Set the roll angle correcion to zero.</span>
<span class="linenos">236</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">237</span>
<span class="linenos">238</span>
<span class="linenos">239</span><span class="w">  </span><span class="c1">//For starting the motors: throttle low and yaw left (step 1).</span>
<span class="linenos">240</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1050</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1050</span><span class="p">)</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">241</span><span class="w">  </span><span class="c1">//When yaw stick is back in the center position start the motors (step 2).</span>
<span class="linenos">242</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1050</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1450</span><span class="p">){</span>
<span class="linenos">243</span><span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">244</span>
<span class="linenos">245</span><span class="w">    </span><span class="n">angle_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angle_pitch_acc</span><span class="p">;</span><span class="w">                                          </span><span class="c1">//Set the gyro pitch angle equal to the accelerometer pitch angle when the quadcopter is started.</span>
<span class="linenos">246</span><span class="w">    </span><span class="n">angle_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angle_roll_acc</span><span class="p">;</span><span class="w">                                            </span><span class="c1">//Set the gyro roll angle equal to the accelerometer roll angle when the quadcopter is started.</span>
<span class="linenos">247</span><span class="w">    </span><span class="n">gyro_angles_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">true</span><span class="p">;</span><span class="w">                                                 </span><span class="c1">//Set the IMU started flag.</span>
<span class="linenos">248</span>
<span class="linenos">249</span><span class="w">    </span><span class="c1">//Reset the PID controllers for a bumpless start.</span>
<span class="linenos">250</span><span class="w">    </span><span class="n">pid_i_mem_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">251</span><span class="w">    </span><span class="n">pid_last_roll_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">252</span><span class="w">    </span><span class="n">pid_i_mem_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">253</span><span class="w">    </span><span class="n">pid_last_pitch_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">254</span><span class="w">    </span><span class="n">pid_i_mem_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">255</span><span class="w">    </span><span class="n">pid_last_yaw_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">256</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">257</span><span class="w">  </span><span class="c1">//Stopping the motors: throttle low and yaw right.</span>
<span class="linenos">258</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1050</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1950</span><span class="p">)</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">259</span>
<span class="linenos">260</span><span class="w">  </span><span class="c1">//The PID set point in degrees per second is determined by the roll receiver input.</span>
<span class="linenos">261</span><span class="w">  </span><span class="c1">//In the case of deviding by 3 the max roll rate is aprox 164 degrees per second ( (500-8)/3 = 164d/s ).</span>
<span class="linenos">262</span><span class="w">  </span><span class="n">pid_roll_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">263</span><span class="w">  </span><span class="c1">//We need a little dead band of 16us for better results.</span>
<span class="linenos">264</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">receiver_input_channel_1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1508</span><span class="p">)</span><span class="n">pid_roll_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiver_input_channel_1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1508</span><span class="p">;</span>
<span class="linenos">265</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">receiver_input_channel_1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1492</span><span class="p">)</span><span class="n">pid_roll_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiver_input_channel_1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1492</span><span class="p">;</span>
<span class="linenos">266</span>
<span class="linenos">267</span><span class="w">  </span><span class="n">pid_roll_setpoint</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">roll_level_adjust</span><span class="p">;</span><span class="w">                                   </span><span class="c1">//Subtract the angle correction from the standardized receiver roll input value.</span>
<span class="linenos">268</span><span class="w">  </span><span class="n">pid_roll_setpoint</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mf">3.0</span><span class="p">;</span><span class="w">                                                 </span><span class="c1">//Divide the setpoint for the PID roll controller by 3 to get angles in degrees.</span>
<span class="linenos">269</span>
<span class="linenos">270</span>
<span class="linenos">271</span><span class="w">  </span><span class="c1">//The PID set point in degrees per second is determined by the pitch receiver input.</span>
<span class="linenos">272</span><span class="w">  </span><span class="c1">//In the case of deviding by 3 the max pitch rate is aprox 164 degrees per second ( (500-8)/3 = 164d/s ).</span>
<span class="linenos">273</span><span class="w">  </span><span class="n">pid_pitch_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">274</span><span class="w">  </span><span class="c1">//We need a little dead band of 16us for better results.</span>
<span class="linenos">275</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">receiver_input_channel_2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1508</span><span class="p">)</span><span class="n">pid_pitch_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiver_input_channel_2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1508</span><span class="p">;</span>
<span class="linenos">276</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">receiver_input_channel_2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1492</span><span class="p">)</span><span class="n">pid_pitch_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiver_input_channel_2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1492</span><span class="p">;</span>
<span class="linenos">277</span>
<span class="linenos">278</span><span class="w">  </span><span class="n">pid_pitch_setpoint</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">pitch_level_adjust</span><span class="p">;</span><span class="w">                                  </span><span class="c1">//Subtract the angle correction from the standardized receiver pitch input value.</span>
<span class="linenos">279</span><span class="w">  </span><span class="n">pid_pitch_setpoint</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mf">3.0</span><span class="p">;</span><span class="w">                                                 </span><span class="c1">//Divide the setpoint for the PID pitch controller by 3 to get angles in degrees.</span>
<span class="linenos">280</span>
<span class="linenos">281</span><span class="w">  </span><span class="c1">//The PID set point in degrees per second is determined by the yaw receiver input.</span>
<span class="linenos">282</span><span class="w">  </span><span class="c1">//In the case of deviding by 3 the max yaw rate is aprox 164 degrees per second ( (500-8)/3 = 164d/s ).</span>
<span class="linenos">283</span><span class="w">  </span><span class="n">pid_yaw_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">284</span><span class="w">  </span><span class="c1">//We need a little dead band of 16us for better results.</span>
<span class="linenos">285</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1050</span><span class="p">){</span><span class="w"> </span><span class="c1">//Do not yaw when turning off the motors.</span>
<span class="linenos">286</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1508</span><span class="p">)</span><span class="n">pid_yaw_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1508</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">;</span>
<span class="linenos">287</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1492</span><span class="p">)</span><span class="n">pid_yaw_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1492</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">;</span>
<span class="linenos">288</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">289</span>
<span class="linenos">290</span><span class="w">  </span><span class="n">calculate_pid</span><span class="p">();</span><span class="w">                                                            </span><span class="c1">//PID inputs are known. So we can calculate the pid output.</span>
<span class="linenos">291</span>
<span class="linenos">292</span><span class="w">  </span><span class="c1">//The battery voltage is needed for compensation.</span>
<span class="linenos">293</span><span class="w">  </span><span class="c1">//A complementary filter is used to reduce noise.</span>
<span class="linenos">294</span><span class="w">  </span><span class="c1">//0.09853 = 0.08 * 1.2317.</span>
<span class="linenos">295</span><span class="w">  </span><span class="c1">//battery_voltage = battery_voltage * 0.92 + (analogRead(0) + 65) * 0.09853;</span>
<span class="linenos">296</span>
<span class="linenos">297</span><span class="w">  </span><span class="c1">//Turn on the led if battery voltage is to low.</span>
<span class="linenos">298</span><span class="w">  </span><span class="c1">//if(battery_voltage &lt; 1000 &amp;&amp; battery_voltage &gt; 600)digitalWrite(12, HIGH);</span>
<span class="linenos">299</span>
<span class="linenos">300</span>
<span class="linenos">301</span><span class="w">  </span><span class="n">throttle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiver_input_channel_3</span><span class="p">;</span><span class="w">                                      </span><span class="c1">//We need the throttle signal as a base signal.</span>
<span class="linenos">302</span>
<span class="linenos">303</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">){</span><span class="w">                                                          </span><span class="c1">//The motors are started.</span>
<span class="linenos">304</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">throttle</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1800</span><span class="p">)</span><span class="w"> </span><span class="n">throttle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1800</span><span class="p">;</span><span class="w">                                   </span><span class="c1">//We need some room to keep full control at full throttle.</span>
<span class="linenos">305</span><span class="w">    </span><span class="n">esc_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">throttle</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_output_yaw</span><span class="p">;</span><span class="w"> </span><span class="c1">//Calculate the pulse for esc 1 (front-right - CCW)</span>
<span class="linenos">306</span><span class="w">    </span><span class="n">esc_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">throttle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_output_yaw</span><span class="p">;</span><span class="w"> </span><span class="c1">//Calculate the pulse for esc 2 (rear-right - CW)</span>
<span class="linenos">307</span><span class="w">    </span><span class="n">esc_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">throttle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_output_yaw</span><span class="p">;</span><span class="w"> </span><span class="c1">//Calculate the pulse for esc 3 (rear-left - CCW)</span>
<span class="linenos">308</span><span class="w">    </span><span class="n">esc_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">throttle</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_output_yaw</span><span class="p">;</span><span class="w"> </span><span class="c1">//Calculate the pulse for esc 4 (front-left - CW)</span>
<span class="linenos">309</span>
<span class="linenos">310</span><span class="w">    </span><span class="c1">// if (battery_voltage &lt; 1240 &amp;&amp; battery_voltage &gt; 800){                   //Is the battery connected?</span>
<span class="linenos">311</span><span class="w">    </span><span class="c1">//   esc_1 += esc_1 * ((1240 - battery_voltage)/(float)3500);              //Compensate the esc-1 pulse for voltage drop.</span>
<span class="linenos">312</span><span class="w">    </span><span class="c1">//   esc_2 += esc_2 * ((1240 - battery_voltage)/(float)3500);              //Compensate the esc-2 pulse for voltage drop.</span>
<span class="linenos">313</span><span class="w">    </span><span class="c1">//   esc_3 += esc_3 * ((1240 - battery_voltage)/(float)3500);              //Compensate the esc-3 pulse for voltage drop.</span>
<span class="linenos">314</span><span class="w">    </span><span class="c1">//   esc_4 += esc_4 * ((1240 - battery_voltage)/(float)3500);              //Compensate the esc-4 pulse for voltage drop.</span>
<span class="linenos">315</span><span class="w">    </span><span class="c1">// }</span>
<span class="linenos">316</span>
<span class="linenos">317</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">esc_1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1100</span><span class="p">)</span><span class="w"> </span><span class="n">esc_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1100</span><span class="p">;</span><span class="w">                                         </span><span class="c1">//Keep the motors running.</span>
<span class="linenos">318</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">esc_2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1100</span><span class="p">)</span><span class="w"> </span><span class="n">esc_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1100</span><span class="p">;</span><span class="w">                                         </span><span class="c1">//Keep the motors running.</span>
<span class="linenos">319</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">esc_3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1100</span><span class="p">)</span><span class="w"> </span><span class="n">esc_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1100</span><span class="p">;</span><span class="w">                                         </span><span class="c1">//Keep the motors running.</span>
<span class="linenos">320</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">esc_4</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1100</span><span class="p">)</span><span class="w"> </span><span class="n">esc_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1100</span><span class="p">;</span><span class="w">                                         </span><span class="c1">//Keep the motors running.</span>
<span class="linenos">321</span>
<span class="linenos">322</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">esc_1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span><span class="n">esc_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">                                           </span><span class="c1">//Limit the esc-1 pulse to 2000us.</span>
<span class="linenos">323</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">esc_2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span><span class="n">esc_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">                                           </span><span class="c1">//Limit the esc-2 pulse to 2000us.</span>
<span class="linenos">324</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">esc_3</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span><span class="n">esc_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">                                           </span><span class="c1">//Limit the esc-3 pulse to 2000us.</span>
<span class="linenos">325</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">esc_4</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span><span class="n">esc_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">;</span><span class="w">                                           </span><span class="c1">//Limit the esc-4 pulse to 2000us.</span>
<span class="linenos">326</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">327</span>
<span class="linenos">328</span><span class="w">  </span><span class="k">else</span><span class="p">{</span>
<span class="linenos">329</span><span class="w">    </span><span class="n">esc_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">                                                           </span><span class="c1">//If start is not 2 keep a 1000us pulse for ess-1.</span>
<span class="linenos">330</span><span class="w">    </span><span class="n">esc_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">                                                           </span><span class="c1">//If start is not 2 keep a 1000us pulse for ess-2.</span>
<span class="linenos">331</span><span class="w">    </span><span class="n">esc_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">                                                           </span><span class="c1">//If start is not 2 keep a 1000us pulse for ess-3.</span>
<span class="linenos">332</span><span class="w">    </span><span class="n">esc_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">                                                           </span><span class="c1">//If start is not 2 keep a 1000us pulse for ess-4.</span>
<span class="linenos">333</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">334</span>
<span class="linenos">335</span><span class="w">  </span><span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">336</span><span class="w">  </span><span class="c1">//Creating the pulses for the ESC&#39;s is explained in this video:</span>
<span class="linenos">337</span><span class="w">  </span><span class="c1">//https://youtu.be/fqEkVcqxtU8</span>
<span class="linenos">338</span><span class="w">  </span><span class="c1">////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">339</span>
<span class="linenos">340</span><span class="w">  </span><span class="c1">//! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! !</span>
<span class="linenos">341</span><span class="w">  </span><span class="c1">//Because of the angle calculation the loop time is getting very important. If the loop time is</span>
<span class="linenos">342</span><span class="w">  </span><span class="c1">//longer or shorter than 4000us the angle calculation is off. If you modify the code make sure</span>
<span class="linenos">343</span><span class="w">  </span><span class="c1">//that the loop time is still 4000us and no longer! More information can be found on</span>
<span class="linenos">344</span><span class="w">  </span><span class="c1">//the Q&amp;A page:</span>
<span class="linenos">345</span><span class="w">  </span><span class="c1">//! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! !</span>
<span class="linenos">346</span>
<span class="linenos">347</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nf">micros</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">loop_timer</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4050</span><span class="p">)</span><span class="nf">digitalWrite</span><span class="p">(</span><span class="kr">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="kr">HIGH</span><span class="p">);</span><span class="w">                   </span><span class="c1">//Turn on the LED if the loop time exceeds 4050us.</span>
<span class="linenos">348</span>
<span class="linenos">349</span><span class="w">  </span><span class="c1">//All the information for controlling the motor&#39;s is available.</span>
<span class="linenos">350</span><span class="w">  </span><span class="c1">//The refresh rate is 250Hz. That means the esc&#39;s need there pulse every 4ms.</span>
<span class="linenos">351</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nf">micros</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">loop_timer</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4000</span><span class="p">);</span><span class="w">                                      </span><span class="c1">//We wait until 4000us are passed.</span>
<span class="linenos">352</span><span class="w">  </span><span class="n">loop_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">micros</span><span class="p">();</span><span class="w">                                                    </span><span class="c1">//Set the timer for the next loop.</span>
<span class="linenos">353</span>
<span class="linenos">354</span><span class="w">  </span><span class="n">esc_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">esc_1</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos">355</span><span class="w">  </span><span class="n">esc_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">esc_2</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos">356</span><span class="w">  </span><span class="n">esc_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">esc_3</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos">357</span><span class="w">  </span><span class="n">esc_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">esc_4</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos">358</span>
<span class="linenos">359</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">esc_1</span><span class="p">);</span>
<span class="linenos">360</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">esc_2</span><span class="p">);</span>
<span class="linenos">361</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_BOTTOM_LEFT</span><span class="p">,</span><span class="w"> </span><span class="n">esc_3</span><span class="p">);</span>
<span class="linenos">362</span><span class="w">  </span><span class="nf">analogWrite</span><span class="p">(</span><span class="n">MOT_TOP_LEFT</span><span class="p">,</span><span class="w"> </span><span class="n">esc_4</span><span class="p">);</span>
<span class="linenos">363</span><span class="w">  </span><span class="c1">//There is always 1000us of spare time. So let&#39;s do something usefull that is very time consuming.</span>
<span class="linenos">364</span><span class="w">  </span><span class="c1">//Get the current gyro and receiver data and scale it to degrees per second for the pid calculations.</span>
<span class="linenos">365</span><span class="w">  </span><span class="n">gyro_signalen</span><span class="p">();</span>
<span class="linenos">366</span><span class="p">}</span>
<span class="linenos">367</span>
<span class="linenos">368</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">369</span><span class="c1">//Subroutine for reading the gyro</span>
<span class="linenos">370</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">371</span><span class="kr">void</span><span class="w"> </span><span class="nf">gyro_signalen</span><span class="p">(){</span>
<span class="linenos">372</span><span class="w">  </span><span class="c1">//Read the MPU-6050</span>
<span class="linenos">373</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">gyro_address</span><span class="p">);</span><span class="w">                                   </span><span class="c1">//Start communication with the gyro.</span>
<span class="linenos">374</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x3B</span><span class="p">);</span><span class="w">                                                       </span><span class="c1">//Start reading @ register 43h and auto increment with every read.</span>
<span class="linenos">375</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span><span class="w">                                                 </span><span class="c1">//End the transmission.</span>
<span class="linenos">376</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">requestFrom</span><span class="p">(</span><span class="n">gyro_address</span><span class="p">,</span><span class="mi">14</span><span class="p">);</span><span class="w">                                      </span><span class="c1">//Request 14 bytes from the gyro.</span>
<span class="linenos">377</span><span class="w">  </span><span class="c1">// Read Udp packet if available</span>
<span class="linenos">378</span><span class="w">  </span><span class="kr">int</span><span class="w"> </span><span class="n">packetSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Udp</span><span class="p">.</span><span class="nf">parsePacket</span><span class="p">();</span>
<span class="linenos">379</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">packetSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">380</span><span class="w">    </span><span class="kr">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Udp</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">UDP_PKT_MAX_SIZE</span><span class="p">);</span>
<span class="linenos">381</span><span class="w">    </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">382</span><span class="w">    </span><span class="kr">char</span><span class="w"> </span><span class="n">ch1</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch2</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch3</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">ch4</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="linenos">383</span><span class="w">    </span><span class="n">ch1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch3</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">ch4</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos">384</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">385</span><span class="w">      </span><span class="n">ch4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">386</span><span class="w">      </span><span class="n">ch3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos">387</span><span class="w">      </span><span class="n">ch1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">];</span>
<span class="linenos">388</span><span class="w">      </span><span class="n">ch2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">];</span>
<span class="linenos">389</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">390</span><span class="w">    </span><span class="n">receiver_input_channel_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch1</span><span class="p">);</span><span class="w"> </span><span class="c1">// ROLL</span>
<span class="linenos">391</span><span class="w">    </span><span class="n">receiver_input_channel_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch2</span><span class="p">);</span><span class="w"> </span><span class="c1">// PITCH</span>
<span class="linenos">392</span><span class="w">    </span><span class="n">receiver_input_channel_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch3</span><span class="p">);</span><span class="w"> </span><span class="c1">// THROTTLE</span>
<span class="linenos">393</span><span class="w">    </span><span class="n">receiver_input_channel_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">ch4</span><span class="p">);</span><span class="w"> </span><span class="c1">// YAW</span>
<span class="linenos">394</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">395</span>
<span class="linenos">396</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">available</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">14</span><span class="p">);</span><span class="w">                                           </span><span class="c1">//Wait until the 14 bytes are received.</span>
<span class="linenos">397</span><span class="w">  </span><span class="n">acc_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w">                               </span><span class="c1">//Add the low and high byte to the acc_x variable.</span>
<span class="linenos">398</span><span class="w">  </span><span class="n">acc_axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w">                               </span><span class="c1">//Add the low and high byte to the acc_y variable.</span>
<span class="linenos">399</span><span class="w">  </span><span class="n">acc_axis</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w">                               </span><span class="c1">//Add the low and high byte to the acc_z variable.</span>
<span class="linenos">400</span><span class="w">  </span><span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w">                               </span><span class="c1">//Add the low and high byte to the temperature variable.</span>
<span class="linenos">401</span><span class="w">  </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w">                              </span><span class="c1">//Read high and low part of the angular data.</span>
<span class="linenos">402</span><span class="w">  </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w">                              </span><span class="c1">//Read high and low part of the angular data.</span>
<span class="linenos">403</span><span class="w">  </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="o">|</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span><span class="w">                              </span><span class="c1">//Read high and low part of the angular data.</span>
<span class="linenos">404</span>
<span class="linenos">405</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">cal_int</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2000</span><span class="p">){</span>
<span class="linenos">406</span><span class="w">    </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w">                                       </span><span class="c1">//Only compensate after the calibration.</span>
<span class="linenos">407</span><span class="w">    </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">                                       </span><span class="c1">//Only compensate after the calibration.</span>
<span class="linenos">408</span><span class="w">    </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">gyro_axis_cal</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w">                                       </span><span class="c1">//Only compensate after the calibration.</span>
<span class="linenos">409</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">410</span><span class="w">  </span><span class="n">gyro_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mb">0b00000010</span><span class="p">];</span><span class="w">                      </span><span class="c1">//Set gyro_roll to the correct axis that was stored in the EEPROM.</span>
<span class="linenos">411</span><span class="w">  </span><span class="n">gyro_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mb">0b00000001</span><span class="p">];</span><span class="w">                     </span><span class="c1">//Set gyro_pitch to the correct axis that was stored in the EEPROM.</span>
<span class="linenos">412</span><span class="w">  </span><span class="n">gyro_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gyro_axis</span><span class="p">[</span><span class="mb">0b00000011</span><span class="p">];</span><span class="w">                       </span><span class="c1">//Set gyro_yaw to the correct axis that was stored in the EEPROM.</span>
<span class="linenos">413</span><span class="w">  </span><span class="n">gyro_yaw</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">                           </span><span class="c1">//Invert gyro_yaw if the MSB of EEPROM bit 30 is set.</span>
<span class="linenos">414</span><span class="w">  </span><span class="n">acc_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc_axis</span><span class="p">[</span><span class="mb">0b00000001</span><span class="p">];</span><span class="w">                           </span><span class="c1">//Set acc_x to the correct axis that was stored in the EEPROM.</span>
<span class="linenos">415</span><span class="w">  </span><span class="n">acc_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc_axis</span><span class="p">[</span><span class="mb">0b00000010</span><span class="p">];</span><span class="w">                           </span><span class="c1">//Set acc_y to the correct axis that was stored in the EEPROM.</span>
<span class="linenos">416</span><span class="w">  </span><span class="n">acc_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc_axis</span><span class="p">[</span><span class="mb">0b00000011</span><span class="p">];</span><span class="w">                           </span><span class="c1">//Set acc_z to the correct axis that was stored in the EEPROM.</span>
<span class="linenos">417</span><span class="w">  </span><span class="n">acc_z</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">                              </span><span class="c1">//Invert acc_z if the MSB of EEPROM bit 30 is set.</span>
<span class="linenos">418</span><span class="p">}</span>
<span class="linenos">419</span>
<span class="linenos">420</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">421</span><span class="c1">//Subroutine for calculating pid outputs</span>
<span class="linenos">422</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">423</span><span class="c1">//The PID controllers are explained in part 5 of the YMFC-3D video session:</span>
<span class="linenos">424</span><span class="c1">//https://youtu.be/JBvnB0279-Q</span>
<span class="linenos">425</span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="linenos">426</span><span class="kr">void</span><span class="w"> </span><span class="nf">calculate_pid</span><span class="p">(){</span>
<span class="linenos">427</span><span class="w">  </span><span class="c1">//Roll calculations</span>
<span class="linenos">428</span><span class="w">  </span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gyro_roll_input</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_roll_setpoint</span><span class="p">;</span>
<span class="linenos">429</span><span class="w">  </span><span class="n">pid_i_mem_roll</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">pid_i_gain_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="p">;</span>
<span class="linenos">430</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid_i_mem_roll</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="p">)</span><span class="n">pid_i_mem_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="p">;</span>
<span class="linenos">431</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">pid_i_mem_roll</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="n">pid_i_mem_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">432</span>
<span class="linenos">433</span><span class="w">  </span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_p_gain_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_i_mem_roll</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_d_gain_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_last_roll_d_error</span><span class="p">);</span>
<span class="linenos">434</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="p">)</span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="p">;</span>
<span class="linenos">435</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="n">pid_output_roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_roll</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">436</span>
<span class="linenos">437</span><span class="w">  </span><span class="n">pid_last_roll_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="p">;</span>
<span class="linenos">438</span>
<span class="linenos">439</span><span class="w">  </span><span class="c1">//Pitch calculations</span>
<span class="linenos">440</span><span class="w">  </span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gyro_pitch_input</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_pitch_setpoint</span><span class="p">;</span>
<span class="linenos">441</span><span class="w">  </span><span class="n">pid_i_mem_pitch</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">pid_i_gain_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="p">;</span>
<span class="linenos">442</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid_i_mem_pitch</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="p">)</span><span class="n">pid_i_mem_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="p">;</span>
<span class="linenos">443</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">pid_i_mem_pitch</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="n">pid_i_mem_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">444</span>
<span class="linenos">445</span><span class="w">  </span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_p_gain_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_i_mem_pitch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_d_gain_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_last_pitch_d_error</span><span class="p">);</span>
<span class="linenos">446</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="p">)</span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="p">;</span>
<span class="linenos">447</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="n">pid_output_pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_pitch</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">448</span>
<span class="linenos">449</span><span class="w">  </span><span class="n">pid_last_pitch_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="p">;</span>
<span class="linenos">450</span>
<span class="linenos">451</span><span class="w">  </span><span class="c1">//Yaw calculations</span>
<span class="linenos">452</span><span class="w">  </span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gyro_yaw_input</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_yaw_setpoint</span><span class="p">;</span>
<span class="linenos">453</span><span class="w">  </span><span class="n">pid_i_mem_yaw</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">pid_i_gain_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="p">;</span>
<span class="linenos">454</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid_i_mem_yaw</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="p">)</span><span class="n">pid_i_mem_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="p">;</span>
<span class="linenos">455</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">pid_i_mem_yaw</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="n">pid_i_mem_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">456</span>
<span class="linenos">457</span><span class="w">  </span><span class="n">pid_output_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_p_gain_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_i_mem_yaw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pid_d_gain_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">pid_error_temp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pid_last_yaw_d_error</span><span class="p">);</span>
<span class="linenos">458</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid_output_yaw</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="p">)</span><span class="n">pid_output_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="p">;</span>
<span class="linenos">459</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">pid_output_yaw</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="n">pid_output_yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_max_yaw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">460</span>
<span class="linenos">461</span><span class="w">  </span><span class="n">pid_last_yaw_d_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid_error_temp</span><span class="p">;</span>
<span class="linenos">462</span><span class="p">}</span>
<span class="linenos">463</span>
<span class="linenos">464</span>
<span class="linenos">465</span><span class="kr">void</span><span class="w"> </span><span class="nf">set_gyro_registers</span><span class="p">(){</span>
<span class="linenos">466</span><span class="w">  </span><span class="c1">//Setup the MPU-6050</span>
<span class="linenos">467</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">gyro_address</span><span class="p">);</span><span class="w">                                      </span><span class="c1">//Start communication with the address found during search.</span>
<span class="linenos">468</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x6B</span><span class="p">);</span><span class="w"> </span><span class="c1">// PWR_MGMT_1                                                    //We want to write to the PWR_MGMT_1 register (6B hex)</span>
<span class="linenos">469</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w">                                                          </span><span class="c1">//Set the register bits as 00000000 to activate the gyro</span>
<span class="linenos">470</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span><span class="w">                                                    </span><span class="c1">//End the transmission with the gyro.</span>
<span class="linenos">471</span>
<span class="linenos">472</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">gyro_address</span><span class="p">);</span><span class="w">                                      </span><span class="c1">//Start communication with the address found during search.</span>
<span class="linenos">473</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x1B</span><span class="p">);</span><span class="w"> </span><span class="c1">// GYRO_CONFIG                                                      //We want to write to the GYRO_CONFIG register (1B hex)</span>
<span class="linenos">474</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x08</span><span class="p">);</span><span class="w">                                                          </span><span class="c1">//Set the register bits as 00001000 (500dps full scale)</span>
<span class="linenos">475</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span><span class="w">                                                    </span><span class="c1">//End the transmission with the gyro</span>
<span class="linenos">476</span>
<span class="linenos">477</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">gyro_address</span><span class="p">);</span><span class="w">                                      </span><span class="c1">//Start communication with the address found during search.</span>
<span class="linenos">478</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x1C</span><span class="p">);</span><span class="w"> </span><span class="c1">// ACCEL_CONFIG                                                      //We want to write to the ACCEL_CONFIG register (1A hex)</span>
<span class="linenos">479</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span><span class="w">                                                          </span><span class="c1">//Set the register bits as 00010000 (+/- 8g full scale range)</span>
<span class="linenos">480</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span><span class="w">                                                    </span><span class="c1">//End the transmission with the gyro</span>
<span class="linenos">481</span>
<span class="linenos">482</span><span class="w">  </span><span class="c1">//Let&#39;s perform a random register check to see if the values are written correct</span>
<span class="linenos">483</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">gyro_address</span><span class="p">);</span><span class="w">                                      </span><span class="c1">//Start communication with the address found during search</span>
<span class="linenos">484</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x1B</span><span class="p">);</span><span class="w">                                                          </span><span class="c1">//Start reading @ register 0x1B</span>
<span class="linenos">485</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span><span class="w">                                                    </span><span class="c1">//End the transmission</span>
<span class="linenos">486</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">requestFrom</span><span class="p">(</span><span class="n">gyro_address</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">                                         </span><span class="c1">//Request 1 bytes from the gyro</span>
<span class="linenos">487</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">available</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">                                               </span><span class="c1">//Wait until the 6 bytes are received</span>
<span class="linenos">488</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nf">Wire</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x08</span><span class="p">){</span><span class="w">                                                   </span><span class="c1">//Check if the value is 0x08</span>
<span class="linenos">489</span><span class="w">    </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="kr">HIGH</span><span class="p">);</span><span class="w">                                                   </span><span class="c1">//Turn on the warning led</span>
<span class="linenos">490</span><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="nf">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w">                                                       </span><span class="c1">//Stay in this loop for ever</span>
<span class="linenos">491</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">492</span>
<span class="linenos">493</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">beginTransmission</span><span class="p">(</span><span class="n">gyro_address</span><span class="p">);</span><span class="w">                                      </span><span class="c1">//Start communication with the address found during search</span>
<span class="linenos">494</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x1A</span><span class="p">);</span><span class="w"> </span><span class="c1">// CONFIG                                                      //We want to write to the CONFIG register (1A hex)</span>
<span class="linenos">495</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mh">0x03</span><span class="p">);</span><span class="w">                                                          </span><span class="c1">//Set the register bits as 00000011 (Set Digital Low Pass Filter to ~43Hz)</span>
<span class="linenos">496</span><span class="w">  </span><span class="nf">Wire</span><span class="p">.</span><span class="nf">endTransmission</span><span class="p">();</span><span class="w">                                                    </span><span class="c1">//End the transmission with the gyro</span>
<span class="linenos">497</span><span class="p">}</span>
</pre></div>
</div>
<div class="toctree-wrapper compound">
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Anish Y Natekar.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>